# 档案管理系统 - 业务流程详细设计文档

## 1. 文档概述

### 1.1 文档目的
本文档详细描述档案管理系统的核心业务流程、状态机设计、工作流程规范等，为开发团队提供业务逻辑实现的详细指导，确保系统能够准确反映实际业务需求。

### 1.2 适用范围
- 业务分析师
- 系统架构师
- 开发团队
- 测试团队
- 产品经理

### 1.3 业务流程概览
档案管理系统主要包含以下核心业务流程：
- 用户认证与权限管理流程
- 档案归档管理流程
- 档案借阅管理流程
- 档案销毁管理流程
- 审批工作流程
- 统计报表生成流程

## 2. 用户认证与权限管理流程

### 2.1 用户登录流程
```mermaid
graph TD
    A[用户访问系统] --> B[输入用户名密码]
    B --> C{验证用户信息}
    C -->|验证失败| D[显示错误信息]
    D --> B
    C -->|验证成功| E[生成JWT Token]
    E --> F[获取用户权限]
    F --> G[缓存用户信息]
    G --> H[跳转到主页面]
    
    I[Token过期检查] --> J{Token是否有效}
    J -->|无效| K[清除本地存储]
    K --> L[跳转到登录页]
    J -->|有效| M[继续访问]
```

### 2.2 权限验证流程
```mermaid
graph TD
    A[用户请求资源] --> B[检查Token有效性]
    B -->|Token无效| C[返回401未授权]
    B -->|Token有效| D[解析用户信息]
    D --> E[获取用户角色权限]
    E --> F{检查资源权限}
    F -->|无权限| G[返回403禁止访问]
    F -->|有权限| H[允许访问资源]
    
    I[权限缓存] --> J{缓存是否过期}
    J -->|过期| K[重新加载权限]
    J -->|未过期| L[使用缓存权限]
    K --> E
    L --> F
```

### 2.3 用户状态机设计
```mermaid
stateDiagram-v2
    [*] --> 未激活
    未激活 --> 正常 : 管理员激活
    正常 --> 锁定 : 多次登录失败/管理员锁定
    正常 --> 禁用 : 管理员禁用
    锁定 --> 正常 : 管理员解锁/自动解锁
    禁用 --> 正常 : 管理员启用
    正常 --> 已删除 : 管理员删除
    禁用 --> 已删除 : 管理员删除
    锁定 --> 已删除 : 管理员删除
    已删除 --> [*]
```

## 3. 档案归档管理流程

### 3.1 档案创建流程
```mermaid
graph TD
    A[用户发起档案创建] --> B[填写档案基本信息]
    B --> C[选择档案分类]
    C --> D[设置安全等级]
    D --> E[上传档案文件]
    E --> F{文件格式验证}
    F -->|验证失败| G[提示错误信息]
    G --> E
    F -->|验证成功| H[文件病毒扫描]
    H --> I{扫描结果}
    I -->|发现病毒| J[拒绝上传]
    I -->|安全| K[生成档案编号]
    K --> L[保存档案信息]
    L --> M[创建档案历史记录]
    M --> N[发送通知]
    N --> O[档案创建完成]
```

### 3.2 档案审核流程
```mermaid
graph TD
    A[档案提交审核] --> B[分配审核人员]
    B --> C[审核人员接收通知]
    C --> D[审核档案内容]
    D --> E{审核结果}
    E -->|通过| F[更新档案状态为已审核]
    E -->|拒绝| G[填写拒绝原因]
    G --> H[通知创建人员]
    H --> I[档案状态更新为待修改]
    F --> J[生成审核记录]
    J --> K[通知相关人员]
    K --> L[审核流程结束]
    
    M[创建人员修改档案] --> N[重新提交审核]
    N --> B
```

### 3.3 档案状态机设计
```mermaid
stateDiagram-v2
    [*] --> 草稿
    草稿 --> 待审核 : 提交审核
    草稿 --> 已删除 : 删除草稿
    待审核 --> 已审核 : 审核通过
    待审核 --> 待修改 : 审核拒绝
    待修改 --> 待审核 : 重新提交
    待修改 --> 已删除 : 删除档案
    已审核 --> 已归档 : 正式归档
    已审核 --> 待修改 : 发现问题
    已归档 --> 借出中 : 档案借出
    已归档 --> 待销毁 : 申请销毁
    借出中 --> 已归档 : 归还档案
    借出中 --> 逾期 : 超过借阅期限
    逾期 --> 已归档 : 强制归还
    待销毁 --> 已销毁 : 销毁审批通过
    待销毁 --> 已归档 : 销毁审批拒绝
    已销毁 --> [*]
    已删除 --> [*]
```

## 4. 档案借阅管理流程

### 4.1 借阅申请流程
```mermaid
graph TD
    A[用户发起借阅申请] --> B[搜索档案]
    B --> C[选择要借阅的档案]
    C --> D{检查档案状态}
    D -->|不可借阅| E[提示档案不可借阅]
    D -->|可借阅| F[填写借阅申请]
    F --> G[选择借阅期限]
    G --> H[填写借阅用途]
    H --> I[提交借阅申请]
    I --> J[系统生成申请编号]
    J --> K[分配审批人员]
    K --> L[发送审批通知]
    L --> M[等待审批结果]
```

### 4.2 借阅审批流程
```mermaid
graph TD
    A[审批人员接收通知] --> B[查看借阅申请详情]
    B --> C[检查申请人权限]
    C --> D[检查档案安全等级]
    D --> E{审批决策}
    E -->|批准| F[设置借阅条件]
    F --> G[生成借阅凭证]
    G --> H[更新档案状态]
    H --> I[通知申请人]
    E -->|拒绝| J[填写拒绝原因]
    J --> K[通知申请人]
    K --> L[记录审批日志]
    I --> L
    L --> M[审批流程结束]
    
    N[申请人不满意] --> O[申请复议]
    O --> P[上级审批]
    P --> E
```

### 4.3 借阅状态机设计
```mermaid
stateDiagram-v2
    [*] --> 申请中
    申请中 --> 已批准 : 审批通过
    申请中 --> 已拒绝 : 审批拒绝
    申请中 --> 已取消 : 申请人取消
    已批准 --> 借出中 : 档案借出
    已批准 --> 已过期 : 超过有效期未借出
    借出中 --> 已归还 : 正常归还
    借出中 --> 逾期中 : 超过借阅期限
    逾期中 --> 已归还 : 逾期归还
    逾期中 --> 强制收回 : 管理员强制收回
    已归还 --> [*]
    已拒绝 --> [*]
    已取消 --> [*]
    已过期 --> [*]
    强制收回 --> [*]
```

### 4.4 借阅归还流程
```mermaid
graph TD
    A[借阅人发起归还] --> B[扫描借阅凭证]
    B --> C{验证凭证有效性}
    C -->|无效| D[提示凭证无效]
    C -->|有效| E[检查档案完整性]
    E --> F{档案检查结果}
    F -->|完整| G[确认归还]
    F -->|损坏| H[记录损坏情况]
    H --> I[评估损坏程度]
    I --> J{是否需要赔偿}
    J -->|需要| K[生成赔偿单]
    J -->|不需要| G
    G --> L[更新档案状态]
    L --> M[更新借阅记录]
    M --> N[生成归还凭证]
    N --> O[发送归还通知]
    O --> P[归还流程结束]
```

## 5. 档案销毁管理流程

### 5.1 销毁申请流程
```mermaid
graph TD
    A[档案管理员发起销毁申请] --> B[选择待销毁档案]
    B --> C[检查档案保管期限]
    C --> D{是否满足销毁条件}
    D -->|不满足| E[提示不满足销毁条件]
    D -->|满足| F[填写销毁申请表]
    F --> G[上传销毁依据文件]
    G --> H[提交销毁申请]
    H --> I[生成销毁申请编号]
    I --> J[分配审批流程]
    J --> K[发送审批通知]
    K --> L[等待审批结果]
```

### 5.2 销毁审批流程
```mermaid
graph TD
    A[一级审批人审批] --> B{一级审批结果}
    B -->|通过| C[二级审批人审批]
    B -->|拒绝| D[通知申请人]
    C --> E{二级审批结果}
    E -->|通过| F[三级审批人审批]
    E -->|拒绝| D
    F --> G{三级审批结果}
    G -->|通过| H[生成销毁批准书]
    G -->|拒绝| D
    H --> I[安排销毁执行]
    I --> J[通知相关人员]
    D --> K[记录审批日志]
    J --> K
    K --> L[审批流程结束]
```

### 5.3 销毁执行流程
```mermaid
graph TD
    A[接收销毁批准书] --> B[核实销毁档案清单]
    B --> C[准备销毁设备]
    C --> D[执行档案销毁]
    D --> E[记录销毁过程]
    E --> F[拍摄销毁照片/视频]
    F --> G[生成销毁证明]
    G --> H[更新档案状态]
    H --> I[通知相关人员]
    I --> J[归档销毁记录]
    J --> K[销毁流程结束]
```

## 6. 审批工作流程设计

### 6.1 通用审批流程引擎
```mermaid
graph TD
    A[发起审批申请] --> B[获取审批流程配置]
    B --> C[初始化审批实例]
    C --> D[确定当前审批节点]
    D --> E[分配审批人员]
    E --> F[发送审批通知]
    F --> G[等待审批操作]
    G --> H[接收审批结果]
    H --> I{审批结果}
    I -->|通过| J[流转到下一节点]
    I -->|拒绝| K[结束流程]
    I -->|退回| L[退回到指定节点]
    J --> M{是否最后节点}
    M -->|是| N[审批流程完成]
    M -->|否| D
    L --> D
    K --> O[记录审批日志]
    N --> O
    O --> P[发送结果通知]
```

### 6.2 审批节点配置
```yaml
# 借阅审批流程配置示例
borrow_approval_workflow:
  name: "档案借阅审批流程"
  version: "1.0"
  nodes:
    - id: "start"
      name: "开始节点"
      type: "start"
      next: "dept_manager_approval"
    
    - id: "dept_manager_approval"
      name: "部门经理审批"
      type: "approval"
      approver_type: "role"
      approver_value: "DEPT_MANAGER"
      timeout: 72  # 72小时超时
      actions:
        - approve: "archive_manager_approval"
        - reject: "end"
        - return: "start"
    
    - id: "archive_manager_approval"
      name: "档案管理员审批"
      type: "approval"
      approver_type: "role"
      approver_value: "ARCHIVE_MANAGER"
      timeout: 48
      condition: "security_level >= 3"  # 安全等级3级以上需要
      actions:
        - approve: "end"
        - reject: "end"
        - return: "dept_manager_approval"
    
    - id: "end"
      name: "结束节点"
      type: "end"
```

### 6.3 审批状态机
```mermaid
stateDiagram-v2
    [*] --> 待审批
    待审批 --> 审批中 : 分配审批人
    审批中 --> 已通过 : 审批通过
    审批中 --> 已拒绝 : 审批拒绝
    审批中 --> 已退回 : 审批退回
    审批中 --> 已超时 : 审批超时
    已退回 --> 待审批 : 重新提交
    已超时 --> 待审批 : 重新分配
    已通过 --> [*]
    已拒绝 --> [*]
```

## 7. 统计报表生成流程

### 7.1 报表生成流程
```mermaid
graph TD
    A[用户请求报表] --> B[选择报表类型]
    B --> C[设置查询条件]
    C --> D[验证用户权限]
    D --> E{权限检查}
    E -->|无权限| F[提示权限不足]
    E -->|有权限| G[构建查询语句]
    G --> H[执行数据查询]
    H --> I[数据预处理]
    I --> J[应用统计算法]
    J --> K[生成图表数据]
    K --> L[渲染报表页面]
    L --> M{是否需要导出}
    M -->|是| N[生成导出文件]
    M -->|否| O[显示在线报表]
    N --> P[提供下载链接]
    O --> Q[报表生成完成]
    P --> Q
```

### 7.2 定时报表任务流程
```mermaid
graph TD
    A[定时任务触发] --> B[获取报表任务配置]
    B --> C[检查任务状态]
    C --> D{任务是否启用}
    D -->|未启用| E[跳过任务执行]
    D -->|启用| F[执行数据统计]
    F --> G[生成报表文件]
    G --> H[保存到文件系统]
    H --> I[发送邮件通知]
    I --> J[更新任务执行记录]
    J --> K[清理过期报表文件]
    K --> L[任务执行完成]
```

## 8. 系统集成流程

### 8.1 外部系统集成流程
```mermaid
graph TD
    A[外部系统请求] --> B[API网关接收]
    B --> C[身份认证]
    C --> D{认证结果}
    D -->|失败| E[返回认证错误]
    D -->|成功| F[权限验证]
    F --> G{权限检查}
    G -->|无权限| H[返回权限错误]
    G -->|有权限| I[请求参数验证]
    I --> J{参数验证}
    J -->|失败| K[返回参数错误]
    J -->|成功| L[调用业务服务]
    L --> M[处理业务逻辑]
    M --> N[返回处理结果]
    N --> O[记录访问日志]
    O --> P[响应外部系统]
```

### 8.2 数据同步流程
```mermaid
graph TD
    A[数据变更事件] --> B[发布到消息队列]
    B --> C[同步服务接收消息]
    C --> D[解析变更数据]
    D --> E[数据格式转换]
    E --> F[调用目标系统API]
    F --> G{同步结果}
    G -->|成功| H[更新同步状态]
    G -->|失败| I[记录错误信息]
    I --> J[加入重试队列]
    J --> K{重试次数检查}
    K -->|未超限| L[延迟重试]
    K -->|超限| M[标记同步失败]
    L --> F
    H --> N[发送成功通知]
    M --> O[发送失败告警]
    N --> P[同步流程结束]
    O --> P
```

## 9. 异常处理流程

### 9.1 系统异常处理流程
```mermaid
graph TD
    A[系统异常发生] --> B[异常捕获]
    B --> C[异常分类]
    C --> D{异常类型}
    D -->|业务异常| E[记录业务日志]
    D -->|系统异常| F[记录系统日志]
    D -->|安全异常| G[记录安全日志]
    E --> H[返回友好错误信息]
    F --> I[发送告警通知]
    G --> J[触发安全响应]
    H --> K[用户界面显示]
    I --> L[运维人员处理]
    J --> M[安全团队处理]
    K --> N[异常处理完成]
    L --> N
    M --> N
```

### 9.2 数据恢复流程
```mermaid
graph TD
    A[数据异常检测] --> B[评估影响范围]
    B --> C[确定恢复策略]
    C --> D{恢复类型}
    D -->|增量恢复| E[从备份恢复增量数据]
    D -->|全量恢复| F[从备份恢复全量数据]
    D -->|实时恢复| G[从日志恢复数据]
    E --> H[验证数据完整性]
    F --> H
    G --> H
    H --> I{验证结果}
    I -->|成功| J[切换到恢复数据]
    I -->|失败| K[尝试其他恢复方式]
    K --> C
    J --> L[通知相关人员]
    L --> M[恢复流程完成]
```

## 10. 性能优化流程

### 10.1 查询优化流程
```mermaid
graph TD
    A[检测慢查询] --> B[分析查询语句]
    B --> C[检查索引使用]
    C --> D{索引优化}
    D -->|需要优化| E[创建或调整索引]
    D -->|索引正常| F[检查查询逻辑]
    E --> G[测试查询性能]
    F --> H[优化查询语句]
    H --> G
    G --> I{性能是否改善}
    I -->|是| J[部署优化方案]
    I -->|否| K[考虑其他优化方式]
    K --> L[数据分区]
    L --> M[缓存策略]
    M --> G
    J --> N[监控性能指标]
    N --> O[优化流程完成]
```

### 10.2 缓存更新流程
```mermaid
graph TD
    A[数据更新事件] --> B[识别相关缓存]
    B --> C{缓存更新策略}
    C -->|立即更新| D[同步更新缓存]
    C -->|延迟更新| E[标记缓存过期]
    C -->|删除缓存| F[清除相关缓存]
    D --> G[验证缓存一致性]
    E --> H[下次访问时更新]
    F --> I[下次访问时重建]
    G --> J{一致性检查}
    J -->|一致| K[缓存更新成功]
    J -->|不一致| L[重新更新缓存]
    L --> G
    H --> M[缓存更新完成]
    I --> M
    K --> M
```

## 11. 业务规则配置

### 11.1 档案分类规则
```yaml
# 档案分类业务规则
archive_classification_rules:
  - category: "人事档案"
    security_level: 3
    retention_period: 70  # 保管期限70年
    access_roles: ["HR_MANAGER", "ARCHIVE_MANAGER"]
    approval_workflow: "hr_approval_workflow"
    
  - category: "财务档案"
    security_level: 4
    retention_period: 30
    access_roles: ["FINANCE_MANAGER", "ARCHIVE_MANAGER"]
    approval_workflow: "finance_approval_workflow"
    
  - category: "技术档案"
    security_level: 2
    retention_period: 20
    access_roles: ["TECH_MANAGER", "ARCHIVE_MANAGER", "ENGINEER"]
    approval_workflow: "tech_approval_workflow"
```

### 11.2 借阅权限规则
```yaml
# 借阅权限业务规则
borrow_permission_rules:
  - security_level: 1
    max_borrow_days: 30
    max_concurrent_borrows: 10
    allowed_roles: ["ALL"]
    
  - security_level: 2
    max_borrow_days: 15
    max_concurrent_borrows: 5
    allowed_roles: ["MANAGER", "SENIOR_STAFF"]
    
  - security_level: 3
    max_borrow_days: 7
    max_concurrent_borrows: 3
    allowed_roles: ["MANAGER"]
    
  - security_level: 4
    max_borrow_days: 3
    max_concurrent_borrows: 1
    allowed_roles: ["SENIOR_MANAGER"]
```

## 12. 监控和告警流程

### 12.1 系统监控流程
```mermaid
graph TD
    A[系统运行] --> B[收集监控指标]
    B --> C[指标数据处理]
    C --> D[存储到监控数据库]
    D --> E[实时指标分析]
    E --> F{阈值检查}
    F -->|正常| G[继续监控]
    F -->|异常| H[触发告警]
    H --> I[发送告警通知]
    I --> J[记录告警日志]
    J --> K[等待处理确认]
    K --> L{问题是否解决}
    L -->|已解决| M[关闭告警]
    L -->|未解决| N[升级告警]
    N --> O[通知上级处理]
    M --> G
    O --> K
```

### 12.2 业务监控流程
```mermaid
graph TD
    A[业务操作执行] --> B[记录业务指标]
    B --> C[计算业务KPI]
    C --> D[更新监控面板]
    D --> E{业务指标检查}
    E -->|正常| F[继续业务监控]
    E -->|异常| G[生成业务告警]
    G --> H[分析异常原因]
    H --> I[通知业务负责人]
    I --> J[制定处理方案]
    J --> K[执行处理措施]
    K --> L[验证处理效果]
    L --> M{问题是否解决}
    M -->|是| N[关闭业务告警]
    M -->|否| O[调整处理方案]
    O --> K
    N --> F
```

---

**文档版本**：v1.0  
**创建日期**：2025年1月  
**更新日期**：2025年1月  
**文档状态**：待评审

## 附录

### A. 业务流程图例说明
- 矩形：处理步骤
- 菱形：判断节点
- 圆形：开始/结束节点
- 箭头：流程方向

### B. 状态机图例说明
- 圆角矩形：状态
- 箭头：状态转换
- 标签：转换条件

### C. 相关文档引用
- 《系统架构设计.md》
- 《数据库设计.md》
- 《API接口规范.md》
- 《项目结构与开发流程.md》