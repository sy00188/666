# 微信登录功能使用说明

## 功能概述

本系统已集成微信登录功能，支持两种模式：
- **模拟模式（开发环境）**：无需真实微信账号，使用测试ID即可登录
- **真实模式（生产环境）**：使用微信扫码登录，需配置微信开放平台账号

## 一、开发环境使用（模拟模式）

### 1. 配置

确保 `application.yml` 中的配置为：

```yaml
archive:
  wechat:
    enabled: true
    mock-mode: true  # 开发环境使用模拟模式
```

### 2. 数据库初始化

执行SQL迁移文件：

```bash
mysql -u root -p archive_management < database/07_wechat_login.sql
```

### 3. 启动服务

```bash
# 后端
cd /Users/songyidemac/Desktop/222
./start-backend.sh

# 前端
cd frontend
npm run dev
```

### 4. 使用流程

#### 情况A：首次使用微信登录（未绑定账号）

1. 访问登录页面 `http://localhost:5173/auth/login`
2. 点击"微信登录"按钮
3. 在弹出的对话框中：
   - 输入测试微信ID（如：`test001`）
   - 输入测试昵称（可选，如：`测试用户`）
   - 点击"模拟登录"
4. 系统检测到该微信未绑定，显示绑定对话框
5. 选择绑定方式：

   **方式1：绑定已有账号**
   - 切换到"绑定已有账号"标签
   - 输入现有系统用户名和密码
   - 点击"绑定并登录"

   **方式2：创建新账号**
   - 切换到"创建新账号"标签
   - 填写新用户信息：
     - 用户名（必填）
     - 邮箱（必填）
     - 手机号（可选）
     - 真实姓名（可选）
   - 点击"创建并登录"

6. 绑定成功后自动登录系统

#### 情况B：已绑定账号的微信登录

1. 访问登录页面
2. 点击"微信登录"按钮
3. 输入已绑定的测试微信ID
4. 点击"模拟登录"
5. 直接登录成功，跳转到系统首页

## 二、生产环境使用（真实模式）

### 1. 申请微信开放平台账号

1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 注册并认证开发者账号
3. 创建网站应用
4. 获取 AppID 和 AppSecret
5. 配置授权回调域名

### 2. 配置

修改 `application.yml`：

```yaml
archive:
  wechat:
    enabled: true
    mock-mode: false  # 生产环境关闭模拟模式
    app-id: ${WECHAT_APP_ID:your_real_app_id}
    app-secret: ${WECHAT_APP_SECRET:your_real_app_secret}
    redirect-uri: https://your-domain.com/api/auth/wechat/callback
```

### 3. 环境变量配置

设置环境变量（推荐）：

```bash
export WECHAT_APP_ID="wx1234567890abcdef"
export WECHAT_APP_SECRET="your_real_app_secret_here"
export WECHAT_REDIRECT_URI="https://your-domain.com/api/auth/wechat/callback"
```

### 4. 使用流程

1. 用户点击"微信登录"
2. 系统展示微信二维码
3. 用户使用微信扫码
4. 微信授权后：
   - 已绑定：直接登录
   - 未绑定：引导绑定账号
5. 登录成功

## 三、API接口说明

### 1. 获取微信登录二维码

```
GET /api/auth/wechat/qrcode
```

响应：
```json
{
  "code": 200,
  "message": "生成成功",
  "data": {
    "state": "abc123...",
    "qrcodeUrl": "https://open.weixin.qq.com/connect/qrconnect?...",
    "expiresIn": 300,
    "mockMode": false,
    "message": "请使用微信扫描二维码登录"
  }
}
```

### 2. 模拟微信登录（仅开发模式）

```
POST /api/auth/wechat/mock-login
Content-Type: application/json

{
  "state": "abc123...",
  "mockWechatId": "test001",
  "mockNickname": "测试用户"
}
```

### 3. 检查登录状态

```
GET /api/auth/wechat/status/{state}
```

### 4. 绑定微信账号

```
POST /api/auth/wechat/bind
Content-Type: application/json

{
  "state": "abc123...",
  "createNew": false,
  "username": "existing_user",
  "password": "password123"
}
```

或创建新账号：

```json
{
  "state": "abc123...",
  "createNew": true,
  "newUsername": "new_user",
  "email": "user@example.com",
  "phone": "13800138000",
  "realName": "张三"
}
```

### 5. 解绑微信账号

```
POST /api/auth/wechat/unbind
Authorization: Bearer {token}
```

## 四、数据库表结构

### 1. User表新增字段

```sql
wechat_openid VARCHAR(64) - 微信OpenID
wechat_unionid VARCHAR(64) - 微信UnionID
wechat_nickname VARCHAR(100) - 微信昵称
wechat_avatar VARCHAR(255) - 微信头像
wechat_binding_time DATETIME - 绑定时间
```

### 2. oauth_login_log表（登录日志）

记录所有第三方登录行为，包括：
- 登录提供商（wechat/qq）
- OpenID
- 登录时间
- IP地址
- 登录状态

### 3. wechat_login_state表（状态管理）

临时存储微信登录状态，用于：
- 状态轮询
- 防CSRF攻击
- 二维码过期管理

## 五、测试场景

### 场景1：新用户微信登录并创建账号

```
微信ID：test001
昵称：张三测试
选择：创建新账号
用户名：zhangsan
邮箱：zhangsan@example.com
```

### 场景2：现有用户绑定微信

```
微信ID：test002
昵称：李四测试
选择：绑定已有账号
用户名：admin
密码：Admin@123
```

### 场景3：已绑定用户快速登录

```
微信ID：test001（已绑定）
结果：直接登录成功
```

## 六、常见问题

### Q1：模拟模式下提示"登录失败"？

**A**：检查以下几点：
1. 确认 `mock-mode: true` 已配置
2. 确认数据库迁移文件已执行
3. 检查后端日志错误信息

### Q2：真实模式下二维码无法显示？

**A**：可能原因：
1. AppID或AppSecret配置错误
2. 回调URL未在微信开放平台配置
3. 网络问题，无法访问微信API

### Q3：绑定账号时提示"用户名或密码错误"？

**A**：确认输入的是系统账号的正确凭据，不是微信账号。

### Q4：如何查看微信登录日志？

**A**：查询 `oauth_login_log` 表：

```sql
SELECT * FROM oauth_login_log 
WHERE provider = 'wechat' 
ORDER BY login_time DESC 
LIMIT 20;
```

### Q5：如何清理过期的登录状态？

**A**：执行SQL：

```sql
DELETE FROM wechat_login_state 
WHERE expires_time < NOW();
```

或者配置定时任务自动清理。

## 七、安全建议

1. **生产环境必须使用HTTPS**
2. **定期更新AppSecret**
3. **监控异常登录行为**
4. **限制登录尝试次数**
5. **记录所有OAuth操作日志**
6. **定期清理过期状态数据**

## 八、技术支持

如遇到问题，请：
1. 查看后端日志：`logs/archive-management-error.log`
2. 查看前端控制台错误信息
3. 检查数据库连接和Redis连接
4. 联系系统管理员

---

**版本信息：**
- 微信登录功能版本：v1.0
- 创建日期：2024-01-20
- 更新日期：2024-01-20

