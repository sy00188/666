# 档案管理系统 - 部署指南

## 📋 目录
- [环境要求](#环境要求)
- [快速开始](#快速开始)
- [详细部署步骤](#详细部署步骤)
- [环境变量配置](#环境变量配置)
- [数据库初始化](#数据库初始化)
- [常见问题](#常见问题)

---

## 🔧 环境要求

### 必需软件
- **Java**: JDK 11 或更高版本
- **MySQL**: 8.0 或更高版本
- **Redis**: 6.0 或更高版本
- **RabbitMQ**: 3.8 或更高版本（可选）
- **Node.js**: 16.x 或更高版本（前端）

### 可选软件
- **MinIO**: 用于对象存储（可选，可使用本地文件存储）
- **Docker**: 用于容器化部署
- **Nginx**: 用于反向代理和负载均衡

### 端口占用
- **8080**: 后端服务
- **3306**: MySQL数据库
- **6379**: Redis缓存
- **5672**: RabbitMQ消息队列
- **9000**: MinIO对象存储

---

## 🚀 快速开始

### 方式1: Docker Compose部署（推荐）

```bash
# 1. 克隆项目
git clone <repository-url>
cd archive-management-system

# 2. 配置环境变量
cp env.example .env
# 编辑 .env 文件，填入实际配置

# 3. 启动所有服务
docker-compose up -d

# 4. 查看服务状态
docker-compose ps

# 5. 查看日志
docker-compose logs -f backend
```

### 方式2: 手动部署

```bash
# 1. 配置环境变量
cp env.example .env
vim .env  # 编辑配置

# 2. 启动依赖服务
# MySQL, Redis, RabbitMQ 需要先启动

# 3. 构建后端
mvn clean package -DskipTests

# 4. 运行后端
java -jar target/archive-management-system.jar

# 5. 构建前端
cd frontend
npm install
npm run build

# 6. 部署前端（使用Nginx）
# 将 frontend/dist 目录部署到 Nginx
```

---

## 📝 详细部署步骤

### 1. 环境准备

#### 1.1 安装Java
```bash
# CentOS/RHEL
sudo yum install java-11-openjdk-devel

# Ubuntu/Debian
sudo apt-get install openjdk-11-jdk

# 验证安装
java -version
```

#### 1.2 安装MySQL
```bash
# 使用Docker安装（推荐）
docker run -d \
  --name mysql \
  -p 3306:3306 \
  -e MYSQL_ROOT_PASSWORD=your_password \
  -e MYSQL_DATABASE=archive_management \
  -v mysql_data:/var/lib/mysql \
  mysql:8.0

# 或使用包管理器安装
# CentOS/RHEL
sudo yum install mysql-server

# Ubuntu/Debian
sudo apt-get install mysql-server
```

#### 1.3 安装Redis
```bash
# 使用Docker安装（推荐）
docker run -d \
  --name redis \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:6 redis-server --appendonly yes

# 或使用包管理器安装
sudo yum install redis  # CentOS/RHEL
sudo apt-get install redis-server  # Ubuntu/Debian
```

#### 1.4 安装RabbitMQ（可选）
```bash
# 使用Docker安装（推荐）
docker run -d \
  --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  -e RABBITMQ_DEFAULT_USER=admin \
  -e RABBITMQ_DEFAULT_PASS=admin \
  rabbitmq:3-management
```

### 2. 配置环境变量

#### 2.1 创建环境变量文件
```bash
# 复制示例文件
cp env.example .env

# 编辑文件
vim .env
```

#### 2.2 必需的环境变量
```bash
# 数据库
DB_USERNAME=root
DB_PASSWORD=your_secure_password

# Redis
REDIS_HOST=localhost
REDIS_PASSWORD=your_redis_password

# JWT密钥（生产环境必须修改）
JWT_SECRET=$(openssl rand -base64 64)

# Spring Profile
SPRING_PROFILES_ACTIVE=prod
```

### 3. 数据库初始化

#### 3.1 执行初始化脚本
```bash
# 连接到MySQL
mysql -u root -p

# 创建数据库（如果还未创建）
CREATE DATABASE IF NOT EXISTS archive_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

# 使用数据库
USE archive_management;

# 执行初始化脚本（按顺序）
source 01_database_init.sql
source 02_constraints.sql
source 03_triggers.sql
source 04_init_data.sql
source 05_maintenance.sql
source 06_additional_tables.sql
source database/07_wechat_login.sql
source database/08_backup_table.sql
source database/09_notification_template_table.sql
source database/10_export_task.sql
```

#### 3.2 验证数据库
```sql
-- 检查表是否创建成功
SHOW TABLES;

-- 检查初始数据
SELECT * FROM sys_user LIMIT 5;
SELECT * FROM sys_role LIMIT 5;
```

### 4. 构建和部署后端

#### 4.1 构建项目
```bash
# 使用Maven构建
mvn clean package -DskipTests

# 或使用项目提供的脚本
./local_mvn.sh clean package -DskipTests
```

#### 4.2 运行后端服务

**开发环境：**
```bash
java -jar target/archive-management-system.jar --spring.profiles.active=dev
```

**生产环境：**
```bash
# 方式1: 直接运行
java -jar target/archive-management-system.jar \
  --spring.profiles.active=prod \
  --server.port=8080

# 方式2: 使用systemd服务
# 创建 /etc/systemd/system/archive-management.service
sudo systemctl start archive-management
sudo systemctl enable archive-management

# 方式3: 使用Docker
docker build -f Dockerfile.backend -t archive-management-backend .
docker run -d \
  --name archive-backend \
  -p 8080:8080 \
  --env-file .env \
  archive-management-backend
```

### 5. 构建和部署前端

#### 5.1 安装依赖
```bash
cd frontend
npm install
```

#### 5.2 构建前端
```bash
# 生产构建
npm run build

# 构建输出在 frontend/dist 目录
```

#### 5.3 部署前端

**使用Nginx：**
```nginx
# /etc/nginx/conf.d/archive-management.conf
server {
    listen 80;
    server_name your-domain.com;

    root /var/www/archive-management/frontend/dist;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket支持
    location /ws/ {
        proxy_pass http://localhost:8080/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

```bash
# 重启Nginx
sudo nginx -t
sudo systemctl restart nginx
```

---

## 🔐 环境变量配置

### 完整的环境变量列表

| 变量名 | 说明 | 默认值 | 是否必需 |
|--------|------|--------|----------|
| `DB_USERNAME` | 数据库用户名 | root | 是 |
| `DB_PASSWORD` | 数据库密码 | - | 是 |
| `REDIS_HOST` | Redis主机 | localhost | 否 |
| `REDIS_PORT` | Redis端口 | 6379 | 否 |
| `REDIS_PASSWORD` | Redis密码 | - | 生产环境必需 |
| `RABBITMQ_HOST` | RabbitMQ主机 | localhost | 否 |
| `RABBITMQ_PORT` | RabbitMQ端口 | 5672 | 否 |
| `RABBITMQ_USERNAME` | RabbitMQ用户名 | guest | 否 |
| `RABBITMQ_PASSWORD` | RabbitMQ密码 | guest | 否 |
| `MINIO_ENDPOINT` | MinIO端点 | http://localhost:9000 | 否 |
| `MINIO_ACCESS_KEY` | MinIO访问密钥 | minioadmin | 否 |
| `MINIO_SECRET_KEY` | MinIO秘密密钥 | minioadmin | 否 |
| `JWT_SECRET` | JWT签名密钥 | - | 生产环境必需 |
| `WECHAT_APP_ID` | 微信AppID | - | 启用微信登录时必需 |
| `WECHAT_APP_SECRET` | 微信AppSecret | - | 启用微信登录时必需 |
| `SPRING_PROFILES_ACTIVE` | Spring环境 | dev | 是 |

### 环境变量加载方式

**方式1: 使用.env文件**
```bash
# 创建.env文件
cat > .env << EOF
DB_USERNAME=root
DB_PASSWORD=your_password
SPRING_PROFILES_ACTIVE=prod
EOF

# 加载环境变量并运行
export $(cat .env | xargs)
java -jar target/archive-management-system.jar
```

**方式2: 命令行参数**
```bash
java -jar target/archive-management-system.jar \
  --spring.datasource.username=root \
  --spring.datasource.password=your_password \
  --spring.profiles.active=prod
```

**方式3: 系统环境变量**
```bash
export DB_USERNAME=root
export DB_PASSWORD=your_password
java -jar target/archive-management-system.jar
```

---

## 🗄️ 数据库初始化

### 脚本执行顺序

| 顺序 | 脚本文件 | 说明 |
|------|----------|------|
| 1 | `01_database_init.sql` | 创建基础表结构 |
| 2 | `02_constraints.sql` | 添加约束和索引 |
| 3 | `03_triggers.sql` | 创建触发器 |
| 4 | `04_init_data.sql` | 初始化基础数据 |
| 5 | `05_maintenance.sql` | 维护脚本 |
| 6 | `06_additional_tables.sql` | 附加表 |
| 7 | `database/07_wechat_login.sql` | 微信登录表 |
| 8 | `database/08_backup_table.sql` | 备份表 |
| 9 | `database/09_notification_template_table.sql` | 通知模板表 |
| 10 | `database/10_export_task.sql` | 导出任务表 |

### 一键初始化脚本

```bash
#!/bin/bash
# init_database.sh

DB_USER="root"
DB_PASS="your_password"
DB_NAME="archive_management"

mysql -u $DB_USER -p$DB_PASS $DB_NAME << EOF
source 01_database_init.sql;
source 02_constraints.sql;
source 03_triggers.sql;
source 04_init_data.sql;
source 05_maintenance.sql;
source 06_additional_tables.sql;
source database/07_wechat_login.sql;
source database/08_backup_table.sql;
source database/09_notification_template_table.sql;
source database/10_export_task.sql;
EOF

echo "数据库初始化完成！"
```

---

## 🐳 Docker部署（推荐）

### Docker Compose完整配置

```yaml
version: '3.8'

services:
  mysql:
    image: mysql:8.0
    container_name: archive-mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: archive_management
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database:/docker-entrypoint-initdb.d
    networks:
      - archive-network

  redis:
    image: redis:6
    container_name: archive-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - archive-network

  rabbitmq:
    image: rabbitmq:3-management
    container_name: archive-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USERNAME}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - archive-network

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: archive-backend
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      RABBITMQ_HOST: rabbitmq
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - archive-network

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: archive-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - archive-network

volumes:
  mysql_data:
  redis_data:

networks:
  archive-network:
    driver: bridge
```

### Docker部署命令

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f backend

# 停止服务
docker-compose down

# 重新构建并启动
docker-compose up -d --build
```

---

## 🔍 健康检查

### 检查后端服务

```bash
# 健康检查端点
curl http://localhost:8080/api/actuator/health

# 预期输出
{
  "status": "UP",
  "components": {
    "db": {"status": "UP"},
    "redis": {"status": "UP"},
    "diskSpace": {"status": "UP"}
  }
}
```

### 检查前端服务

```bash
# 访问首页
curl http://localhost:80

# 检查Nginx状态
sudo systemctl status nginx
```

---

## ❓ 常见问题

### Q1: 数据库连接失败

**症状：**
```
Unable to connect to database
```

**解决方案：**
1. 检查MySQL是否启动：`systemctl status mysql`
2. 检查端口是否开放：`netstat -tlnp | grep 3306`
3. 验证数据库凭证是否正确
4. 检查防火墙设置

### Q2: Redis连接超时

**症状：**
```
Redis connection timeout
```

**解决方案：**
1. 检查Redis是否启动：`systemctl status redis`
2. 检查Redis配置：`redis-cli ping`
3. 验证Redis密码是否正确

### Q3: 内存不足

**症状：**
```
OutOfMemoryError: Java heap space
```

**解决方案：**
```bash
# 增加JVM内存
java -Xms512m -Xmx2048m -jar target/archive-management-system.jar
```

### Q4: 端口被占用

**症状：**
```
Port 8080 is already in use
```

**解决方案：**
```bash
# 查找占用端口的进程
lsof -i :8080

# 终止进程
kill -9 <PID>

# 或更改端口
java -jar target/archive-management-system.jar --server.port=8081
```

---

## 🛡️ 安全建议

### 生产环境安全检查清单

- [ ] 所有密码使用强密码（至少16位）
- [ ] JWT密钥使用随机生成的64位字符串
- [ ] 启用HTTPS（使用SSL/TLS证书）
- [ ] 配置防火墙规则
- [ ] 启用Redis密码认证
- [ ] 限制数据库访问IP
- [ ] 定期备份数据库
- [ ] 配置日志轮转
- [ ] 启用审计日志
- [ ] 配置监控告警

---

## 📞 获取帮助

- **文档**: 查看项目README和API文档
- **日志**: 查看`logs/archive-management.log`
- **监控**: 访问`http://localhost:8080/api/actuator`

---

**最后更新**: 2025-01-10  
**版本**: 1.0.0
