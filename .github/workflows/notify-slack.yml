name: Slack é€šçŸ¥ï¼ˆå¯é€‰ï¼‰

# æ­¤å·¥ä½œæµåœ¨ä¸»CIå·¥ä½œæµå®Œæˆåè§¦å‘
# ä»…åœ¨æµ‹è¯•å¤±è´¥æ—¶å‘é€Slacké€šçŸ¥
# éœ€è¦é…ç½® SLACK_WEBHOOK_URL secret

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed

jobs:
  notify-failure:
    name: å‘é€å¤±è´¥é€šçŸ¥åˆ° Slack
    runs-on: ubuntu-latest
    # ä»…åœ¨CIå¤±è´¥æ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å‘é€ Slack é€šçŸ¥
        uses: slackapi/slack-github-action@v1.27.0
        with:
          # ä½¿ç”¨ Incoming Webhook æ–¹å¼
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "âŒ CI/CD æµ‹è¯•å¤±è´¥",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âŒ CI/CD æµ‹è¯•å¤±è´¥",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ä»“åº“:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*åˆ†æ”¯:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*æäº¤è€…:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*äº‹ä»¶:*\n${{ github.event.workflow_run.event }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤ä¿¡æ¯:*\n${{ github.event.workflow_run.head_commit.message }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*å¤±è´¥åŸå› :*\nè¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹å·¥ä½œæµ",
                        "emoji": true
                      },
                      "url": "${{ github.event.workflow_run.html_url }}",
                      "style": "danger"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹æäº¤",
                        "emoji": true
                      },
                      "url": "${{ github.event.workflow_run.head_commit.url }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ• å¤±è´¥æ—¶é—´: <!date^${{ github.event.workflow_run.updated_at }}^{date_num} {time_secs}|${{ github.event.workflow_run.updated_at }}>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  notify-success:
    name: å‘é€æˆåŠŸé€šçŸ¥åˆ° Slackï¼ˆå¯é€‰ï¼‰
    runs-on: ubuntu-latest
    # ä»…åœ¨CIæˆåŠŸä¸”æ˜¯mainåˆ†æ”¯æ—¶è¿è¡Œï¼ˆå¯é€‰ï¼‰
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: å‘é€ Slack é€šçŸ¥
        uses: slackapi/slack-github-action@v1.27.0
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "âœ… CI/CD æµ‹è¯•é€šè¿‡",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "âœ… CI/CD æµ‹è¯•é€šè¿‡",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ä»“åº“:*\n${{ github.repository }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*åˆ†æ”¯:*\n${{ github.event.workflow_run.head_branch }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*æäº¤è€…:*\n${{ github.event.workflow_run.head_commit.author.name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*äº‹ä»¶:*\n${{ github.event.workflow_run.event }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*æäº¤ä¿¡æ¯:*\n${{ github.event.workflow_run.head_commit.message }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹å·¥ä½œæµ",
                        "emoji": true
                      },
                      "url": "${{ github.event.workflow_run.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "æŸ¥çœ‹è¦†ç›–ç‡",
                        "emoji": true
                      },
                      "url": "https://codecov.io/gh/${{ github.repository }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "ğŸ• å®Œæˆæ—¶é—´: <!date^${{ github.event.workflow_run.updated_at }}^{date_num} {time_secs}|${{ github.event.workflow_run.updated_at }}>"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ==================== é…ç½®è¯´æ˜ ====================
# 
# 1. è·å– Slack Webhook URL:
#    - è®¿é—® https://api.slack.com/apps
#    - åˆ›å»ºæ–°åº”ç”¨æˆ–é€‰æ‹©ç°æœ‰åº”ç”¨
#    - å¯ç”¨ "Incoming Webhooks"
#    - æ·»åŠ æ–°çš„ Webhook åˆ°å·¥ä½œåŒº
#    - å¤åˆ¶ Webhook URL
# 
# 2. é…ç½® GitHub Secret:
#    - è¿›å…¥ä»“åº“ Settings > Secrets and variables > Actions
#    - ç‚¹å‡» "New repository secret"
#    - Name: SLACK_WEBHOOK_URL
#    - Value: ç²˜è´´ä½ çš„ Webhook URL
#    - ç‚¹å‡» "Add secret"
# 
# 3. è‡ªå®šä¹‰é€šçŸ¥:
#    - ä¿®æ”¹ payload ä¸­çš„å†…å®¹ä»¥è‡ªå®šä¹‰é€šçŸ¥æ ¼å¼
#    - å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µæˆ–æŒ‰é’®
#    - å‚è€ƒ Slack Block Kit æ–‡æ¡£: https://api.slack.com/block-kit
# 
# 4. å¯ç”¨/ç¦ç”¨é€šçŸ¥:
#    - å¤±è´¥é€šçŸ¥: é»˜è®¤å¯ç”¨
#    - æˆåŠŸé€šçŸ¥: é»˜è®¤ä»…åœ¨mainåˆ†æ”¯å¯ç”¨ï¼Œå¯ä»¥ä¿®æ”¹æ¡ä»¶
#    - å¦‚æœä¸éœ€è¦æŸä¸ªé€šçŸ¥ï¼Œå¯ä»¥åˆ é™¤å¯¹åº”çš„ job
# 
# ==================== æ³¨æ„äº‹é¡¹ ====================
# 
# - æ­¤å·¥ä½œæµæ˜¯å¯é€‰çš„ï¼Œä¸å½±å“CI/CDçš„æ ¸å¿ƒåŠŸèƒ½
# - å¦‚æœæ²¡æœ‰é…ç½® SLACK_WEBHOOK_URLï¼Œå·¥ä½œæµä¼šå¤±è´¥ä½†ä¸å½±å“ä¸»CI
# - å»ºè®®å…ˆé…ç½®å¥½Secretå†å¯ç”¨æ­¤å·¥ä½œæµ
# - å¯ä»¥æ ¹æ®å›¢é˜Ÿéœ€æ±‚è°ƒæ•´é€šçŸ¥çš„è§¦å‘æ¡ä»¶å’Œå†…å®¹

